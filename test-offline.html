<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAMO Cashier 离线功能测试</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .online { background: #28a745; }
        .offline { background: #dc3545; }
        
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 DAMO Cashier 离线功能测试</h1>
        
        <div class="test-section info">
            <h3>📡 网络状态</h3>
            <p>
                当前状态: 
                <span class="status-indicator" id="networkStatus"></span>
                <span id="networkText">检测中...</span>
            </p>
            <button class="btn-warning" onclick="toggleNetwork()">模拟网络切换</button>
        </div>

        <div class="test-section">
            <h3>🧪 功能测试</h3>
            
            <h4>1. 缓存测试</h4>
            <button class="btn-primary" onclick="testCache()">测试数据缓存</button>
            <button class="btn-primary" onclick="testCacheRead()">读取缓存数据</button>
            <div id="cacheResult"></div>

            <h4>2. 离线队列测试</h4>
            <button class="btn-primary" onclick="testOfflineQueue()">添加离线操作</button>
            <button class="btn-primary" onclick="testQueueSync()">同步队列</button>
            <div id="queueResult"></div>

            <h4>3. 网络请求测试</h4>
            <button class="btn-primary" onclick="testOnlineRequest()">在线请求</button>
            <button class="btn-primary" onclick="testOfflineRequest()">离线请求</button>
            <div id="requestResult"></div>
        </div>

        <div class="test-section">
            <h3>📊 测试结果</h3>
            <pre id="testLog">等待测试...</pre>
        </div>

        <div class="test-section success">
            <h3>✅ 测试通过标准</h3>
            <ul>
                <li>✅ 网络状态检测正常</li>
                <li>✅ 数据缓存功能正常</li>
                <li>✅ 离线队列功能正常</li>
                <li>✅ 离线请求处理正常</li>
                <li>✅ 网络恢复后自动同步</li>
            </ul>
        </div>

        <div class="test-section warning">
            <h3>⚠️ 注意事项</h3>
            <ul>
                <li>此测试页面仅用于验证离线功能逻辑</li>
                <li>实际项目中需要在uni-app环境中测试</li>
                <li>建议在真实设备上测试网络切换</li>
                <li>确保服务端API支持幂等操作</li>
            </ul>
        </div>
    </div>

    <script>
        let testLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            testLog.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            document.getElementById('testLog').textContent = testLog.join('\n');
        }

        function updateNetworkStatus() {
            const isOnline = navigator.onLine;
            const statusEl = document.getElementById('networkStatus');
            const textEl = document.getElementById('networkText');
            
            statusEl.className = `status-indicator ${isOnline ? 'online' : 'offline'}`;
            textEl.textContent = isOnline ? '在线' : '离线';
            
            log(`网络状态: ${isOnline ? '在线' : '离线'}`);
        }

        function toggleNetwork() {
            // 模拟网络切换（仅用于演示）
            log('模拟网络切换 - 请在浏览器开发者工具中切换网络状态');
            alert('请在浏览器开发者工具 (F12) -> Network 标签中选择 "Offline" 来模拟离线状态');
        }

        // 模拟缓存功能
        function testCache() {
            const testData = {
                code: 200,
                msg: 'success',
                data: {
                    goods: [
                        { id: 1, name: '商品1', price: 10.00 },
                        { id: 2, name: '商品2', price: 20.00 }
                    ]
                },
                timestamp: Date.now()
            };
            
            localStorage.setItem('test_cache', JSON.stringify(testData));
            log('测试数据已缓存');
            document.getElementById('cacheResult').innerHTML = 
                '<div class="success">✅ 缓存成功</div>';
        }

        function testCacheRead() {
            const cached = localStorage.getItem('test_cache');
            if (cached) {
                const data = JSON.parse(cached);
                log('成功读取缓存数据');
                document.getElementById('cacheResult').innerHTML = 
                    `<div class="success">✅ 缓存读取成功<br><small>${JSON.stringify(data, null, 2)}</small></div>`;
            } else {
                log('未找到缓存数据', 'warning');
                document.getElementById('cacheResult').innerHTML = 
                    '<div class="warning">⚠️ 未找到缓存数据</div>';
            }
        }

        // 模拟离线队列
        function testOfflineQueue() {
            const queueItem = {
                id: Date.now(),
                type: 'order',
                url: '/channel/inStore/order',
                data: {
                    goods: [{ id: 1, quantity: 2 }],
                    total: 20.00
                },
                timestamp: Date.now()
            };
            
            let queue = JSON.parse(localStorage.getItem('offline_queue') || '[]');
            queue.push(queueItem);
            localStorage.setItem('offline_queue', JSON.stringify(queue));
            
            log('离线操作已添加到队列');
            document.getElementById('queueResult').innerHTML = 
                `<div class="success">✅ 已添加到离线队列 (${queue.length} 项)</div>`;
        }

        function testQueueSync() {
            const queue = JSON.parse(localStorage.getItem('offline_queue') || '[]');
            if (queue.length === 0) {
                log('离线队列为空', 'warning');
                document.getElementById('queueResult').innerHTML = 
                    '<div class="warning">⚠️ 离线队列为空</div>';
                return;
            }

            // 模拟同步过程
            log(`开始同步 ${queue.length} 个离线操作`);
            
            setTimeout(() => {
                localStorage.removeItem('offline_queue');
                log('离线队列同步完成');
                document.getElementById('queueResult').innerHTML = 
                    '<div class="success">✅ 离线队列同步完成</div>';
            }, 1000);
        }

        // 模拟网络请求
        function testOnlineRequest() {
            if (!navigator.onLine) {
                log('当前离线，无法进行在线请求', 'error');
                document.getElementById('requestResult').innerHTML = 
                    '<div class="error">❌ 当前离线状态</div>';
                return;
            }

            log('执行在线请求...');
            // 模拟API请求
            setTimeout(() => {
                log('在线请求成功');
                document.getElementById('requestResult').innerHTML = 
                    '<div class="success">✅ 在线请求成功</div>';
            }, 500);
        }

        function testOfflineRequest() {
            if (navigator.onLine) {
                log('当前在线，模拟离线请求处理');
            } else {
                log('当前离线，测试离线请求处理');
            }

            // 模拟离线请求处理
            setTimeout(() => {
                log('离线请求已添加到队列');
                document.getElementById('requestResult').innerHTML = 
                    '<div class="warning">⚠️ 离线请求已保存，等待同步</div>';
            }, 200);
        }

        // 初始化
        window.addEventListener('load', () => {
            updateNetworkStatus();
            log('离线功能测试页面已加载');
        });

        // 监听网络状态变化
        window.addEventListener('online', () => {
            updateNetworkStatus();
            log('网络已连接');
        });

        window.addEventListener('offline', () => {
            updateNetworkStatus();
            log('网络已断开');
        });
    </script>
</body>
</html>